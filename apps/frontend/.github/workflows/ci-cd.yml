name: Frontend CI/CD (prod)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  HOSTING_BUCKET: hradar-hosting
  ARTIFACT_BUCKET: s3-hradar-bucket
  CLOUDFRONT_DISTRIBUTION_ID: E7X7Y7ZUCT1LO
  FRONTEND_DIR: hr-platform

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # Node ì„¤ì •
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm ci

      # prod ëª¨ë“œ ë¹Œë“œ (.env.prod ì‚¬ìš©)
      - name: Build (prod)
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm run build -- --mode prod

      # dist ì••ì¶•
      - name: Zip dist
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          ls -al
          ls -al dist
          zip -r ../dist-${{ github.sha }}.zip dist

      # AWS ì¸ì¦ (OIDC)
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # zip ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: Upload artifact zip
        run: |
          aws s3 cp dist-${{ github.sha }}.zip \
            s3://${ARTIFACT_BUCKET}/dist-${{ github.sha }}.zip

      # ê¸°ì¡´ ì •ì  íŒŒì¼ ì‚­ì œ
      - name: Clear hosting bucket
        run: aws s3 rm s3://${HOSTING_BUCKET} --recursive

      # zip í’€ì–´ì„œ ë°°í¬
      - name: Deploy to hosting bucket
        run: |
          unzip dist-${{ github.sha }}.zip
          aws s3 sync dist s3://${HOSTING_BUCKET}

      # CloudFront ìºì‹œ ë¬´íš¨í™”
      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${CLOUDFRONT_DISTRIBUTION_ID} \
            --paths "/*"

      # Discord ì•Œë¦¼
      - name: Notify Discord
        if: always()
        run: |
          STATUS="SUCCESS"
          if [ "${{ job.status }}" != "success" ]; then
            STATUS="FAILED"
          fi

          curl -H "Content-Type: application/json" \
            -d "{
              \"content\": \"ğŸŒ **Frontend ë°°í¬ ê²°ê³¼**\në¸Œëœì¹˜: \`main\`\nì»¤ë°‹: \`${{ github.sha }}\`\nìƒíƒœ: **${STATUS}**\nURL: https://hradar.link\në¡œê·¸: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
            }" \
            ${{ secrets.DISCORD_FE_WEBHOOK_URL }}
