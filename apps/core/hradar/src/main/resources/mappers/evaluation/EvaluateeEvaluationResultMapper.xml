<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.hit.hradar.domain.evaluation.query.mapper.EvaluateeEvaluationResultMapper">

    <select id="selectEvaluateeResponses"
            resultType="org.hit.hradar.domain.evaluation.query.dto.response.row.EvaluateeResponseRow">

        SELECT
            c.cycle_id              AS cycleId,
            c.cycle_name            AS cycleName,

            et.eval_type_id         AS evalTypeId,
            et.type_name            AS evalTypeName,

            q.question_id           AS questionId,
            q.question_type         AS questionType,
            q.question_content      AS questionContent,

            er.score                AS score,
            er.text_answer          AS textAnswer,

            oo.option_content       AS optionContent

        FROM evaluation_assignment ea
                 JOIN evaluation_response er
                      ON ea.assignment_id = er.assignment_id
                 JOIN evaluation_question q
                      ON er.question_id = q.question_id

                 LEFT JOIN objective_options oo
                           ON er.option_id = oo.option_id

                 JOIN cycle_evaluation_type cet
                      ON ea.cycle_eval_type_id = cet.cycle_eval_type_id
                 JOIN cycle c
                      ON cet.cycle_id = c.cycle_id
                 JOIN evaluation_type et
                      ON cet.eval_type_id = et.eval_type_id

        WHERE ea.evaluatee_id = #{evaluateeId}
          AND ea.assignment_status = 'SUBMITTED'
          AND c.cycle_id = #{cycleId}
          AND et.eval_type_id = #{evalTypeId}

        ORDER BY q.question_id ASC
    </select>

</mapper>
