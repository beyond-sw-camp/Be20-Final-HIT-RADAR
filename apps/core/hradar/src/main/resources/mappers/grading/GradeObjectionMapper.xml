<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.hit.hradar.domain.grading.query.mapper.GradeObjectionMapper">
    <select id="findByIndividualGradeId"
            resultType="org.hit.hradar.domain.grading.query.dto.response.GradeObjectionResponseDto">

        SELECT
            objection_id        AS objectionId,
            objection_reason    AS objectionReason,
            objection_status    AS objectionStatus,
            objection_result    AS objectionResult,
            resolved_by         AS resolvedBy
        FROM grade_objection
        WHERE individual_grade_id = #{individualGradeId}
          AND is_deleted = 'N'
        ORDER BY created_at DESC

    </select>

    <select id="findByDepartment"
            resultType="org.hit.hradar.domain.grading.query.dto.response.GradeObjectionAdminResponseDto">

        SELECT
            go.objection_id          AS objectionId,
            go.individual_grade_id   AS individualGradeId,

            e.emp_id                 AS employeeId,
            e.name                   AS employeeName,
            e.employee_no            AS employeeNo,

            d.dept_id                AS departmentId,
            d.dept_name              AS departmentName,

            go.objection_reason      AS objectionReason,
            go.objection_status      AS objectionStatus,
            go.objection_result      AS objectionResult

        FROM grade_objection go
                 JOIN individual_grade ig
                      ON go.individual_grade_id = ig.individual_grade_id
                          AND ig.is_deleted = 'N'

                 JOIN employee e
                      ON ig.emp_id = e.emp_id
                          AND e.is_deleted = 'N'

                 JOIN department d
                      ON e.dept_id = d.dept_id
                          AND d.is_deleted = 'N'

        WHERE e.com_id = #{companyId}
          AND d.dept_id = #{deptId}
          AND go.is_deleted = 'N'

        ORDER BY go.created_at DESC

    </select>

    <!--전체 사원 이의제기 조회 -->
    <select id="findAllByCompany"
            resultType="org.hit.hradar.domain.grading.query.dto.response.GradeObjectionAdminResponseDto">

        SELECT
            go.objection_id          AS objectionId,
            go.individual_grade_id   AS individualGradeId,

            e.emp_id                 AS employeeId,
            e.name                   AS employeeName,
            e.employee_no            AS employeeNo,

            d.dept_id                AS departmentId,
            d.dept_name              AS departmentName,

            go.objection_reason      AS objectionReason,
            go.objection_status      AS objectionStatus,
            go.objection_result      AS objectionResult

        FROM grade_objection go
                 JOIN individual_grade ig
                      ON go.individual_grade_id = ig.individual_grade_id
                          AND ig.is_deleted = 'N'

                 JOIN employee e
                      ON ig.emp_id = e.emp_id
                          AND e.is_deleted = 'N'

                 JOIN department d
                      ON e.dept_id = d.dept_id
                          AND d.is_deleted = 'N'

        WHERE e.com_id = #{companyId}
          AND go.is_deleted = 'N'

        ORDER BY d.dept_name, e.name, go.created_at DESC

    </select>

</mapper>
