<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.hit.hradar.domain.salary.query.mapper.CompensationSalaryMapper">

  <select id="findAllByCompensationSalaries"
    parameterType="org.hit.hradar.domain.salary.query.dto.request.SalaryApprovalRequest"
    resultType="org.hit.hradar.domain.salary.query.dto.SalaryApprovalDTO">
    <!-- 연봉 목록 조회 (전체)-->
    select year(ad.created_at) as year
         , ad.doc_id
         , ad.title
         , date_format(ad.approved_at, '%y-%m-%d') as approvedAt
         , cse.compensation_type
         , ad.status as approvalStatus
         , emp.name as writer
         , sum(cse.amount) as totalSalary
         , cse.remark
         , count(cse.compensation_salary_employee_id) as empCount
      from approval_document ad
      join employee emp on ad.writer_id = emp.emp_id
      join compensation_salary_employee cse on ad.doc_id = cse.doc_id
     where ad.is_deleted = 'N'
       and ad.company_id = #{comId}
       and ad.doc_type = 'COMPENSATION_SALARY'
    <if test="year != null and year != ''">
      and year(ad.created_at) = #{year}
    </if>
     group by ad.doc_id, ad.title, ad.approved_at, ad.status, ad.writer_id, emp.name, cse.compensation_type, cse.remark
     order by ad.doc_id desc
  </select>

  <select id="findAllByCompensationSalariesByDocId"
    parameterType="org.hit.hradar.domain.salary.query.dto.request.SalaryApprovalRequest"
    resultType="org.hit.hradar.domain.salary.query.dto.SalaryApprovalDTO">
    <!-- 연봉 목록 조회 (전체)-->
    select year(ad.created_at) as year
         , ad.doc_id
         , ad.title
         , date_format(ad.approved_at, '%y-%m-%d') as approvedAt
         , cse.compensation_type
         , ad.status as approvalStatus
         , emp.name as writer
         , sum(cse.amount) as totalSalary
         , cse.remark
         , count(cse.compensation_salary_employee_id) as empCount
      from approval_document ad
      join employee emp on ad.writer_id = emp.emp_id
      join compensation_salary_employee cse on ad.doc_id = cse.doc_id
     where ad.is_deleted = 'N'
       and ad.company_id = #{comId}
       and ad.doc_id = #{docId}
       and ad.doc_type = 'COMPENSATION_SALARY'
     group by ad.doc_id, ad.title, ad.approved_at, ad.status, ad.writer_id, emp.name, cse.compensation_type, cse.remark
     order by ad.doc_id desc
  </select>

  <select id="findAllCompensationSalaries"
    parameterType="org.hit.hradar.domain.salary.query.dto.request.CompensationSearchRequest"
    resultType="org.hit.hradar.domain.salary.query.dto.CompensationSalaryDTO">

    select year(ad.created_at) as year -- 년도
         , ad.doc_id
         , ad.doc_type
         , emp.emp_id  -- 사원 pk
         , emp.employee_no -- 사번
         , emp.name -- 사원명
         , dep.dept_name  -- 부서명
         , cp.name  as positionName -- 직위
         , emp.type as employmentType -- 재직 상태
         , date_format(ad.approved_at, '%Y-%m-%d') as approvedAt
         , cse.remark
         , cse.compensation_type
      from compensation_salary_employee cse
      join approval_document ad on cse.doc_id = ad.doc_id and ad.is_deleted = 'N'
      join employee emp on cse.emp_id = emp.emp_id and emp.is_deleted = 'N'
      join department dep on emp.dept_id = dep.dept_id and dep.is_deleted = 'N'
      join company_position cp on emp.position_id = cp.position_id and cp.is_deleted = 'N'
     where cse.is_deleted = 'N'
       and ad.doc_type = 'COMPENSATION_SALARY'
       and ad.company_id = #{comId}
       and ad.doc_id = #{docId}
    <if test="deptId != null">
      and dep.dept_id = #{deptId}
    </if>
    <if test="comPositionId != null">
      and cp.position_id = #{comPositionId}
    </if>
    <if test="employmentType != null">
      and emp.type = #{employmentType}
    </if>
    <if test="employeeNo != null and employeeNo != ''">
      and emp.employee_no like concat('%', #{employeeNo}, '%')
    </if>
    <if test="employeeName != null and employeeName != ''">
      and emp.name like concat('%', #{employeeName}, '%')
    </if>
    order by emp.name asc
  </select>




  <select id="findAllCompensationHistory"
    parameterType="org.hit.hradar.domain.salary.query.dto.request.CompensationHistorySearchRequest"
    resultType="org.hit.hradar.domain.salary.query.dto.CompensationHistoryDTO">

  select year(ad.created_at) as year
       , cse.compensation_type as type
       , ad.title
       , cse.amount
       , ad.doc_type
       , cse.rate
       , date_format(ad.approved_at, '%y-%m-%d') as approvedAt
       , cse.emp_id
       , ad.status as approvalStatus
       , cse.remark
    from compensation_salary_employee cse
    join approval_document ad on cse.doc_id = ad.doc_id and ad.is_deleted = 'N'
   where cse.is_deleted = 'N'
     and ad.doc_type = 'COMPENSATION_SALARY'
     and ad.company_id = #{comId}
     and cse.emp_id = #{empId}
    <if test="year != null and year != ''">
     and year(ad.created_at) = #{year}
  </if>
  <if test="type != null">
     and cse.compensation_type = #{type}
  </if>
   order by ad.doc_id desc
  </select>


  <select id="findCompensationSalaries"
    parameterType="org.hit.hradar.domain.salary.query.dto.request.CompensationSearchRequest"
    resultType="org.hit.hradar.domain.salary.query.dto.CompensationSalaryDTO">

  select ad.title
       , sum(case when cse.compensation_type = 'BONUS' then cse.amount
             else 0
              end
       ) as totalBonus
       , sum(case when cse.compensation_type = 'INCENTIVE' then cse.amount
             else 0
              end
       ) as totalIncentive
       , sum(case when cse.compensation_type = 'PERFORMANCE' then cse.amount
             else 0
              end
      ) as totalPerformance
      , sum(case when cse.compensation_type = 'ALLOWANCE' then cse.amount
            else 0
             end
      ) as totalAllowance
      , sum(cse.amount) as totalCompensation
   from compensation_salary_employee cse
   join approval_document ad on cse.doc_id = ad.doc_id and ad.is_deleted = 'N'
  where cse.is_deleted = 'N'
    and ad.status = 'APPROVED'
    and ad.doc_type = 'COMPENSATION_SALARY'
    and ad.approved_at <![CDATA[>=]]> #{startDate}
    and ad.approved_at <![CDATA[<]]> date_add(#{endDate}, interval 1 day)
    and ad.company_id = #{comId}
  <if test="empId != null">
    and cse.emp_id = #{empId}
  </if>
  </select>
</mapper>