<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.hit.hradar.domain.competencyReport.query.mapper.TagMapper">

  <select id="findAllTags"
    parameterType="org.hit.hradar.domain.competencyReport.query.dto.request.TagSearchRequest"
    resultType="org.hit.hradar.domain.competencyReport.query.dto.TagDTO">

    select t.tag_id
         , t.tag_name
         , count(ct.tag_id) as tagCount
      from tag t
      left join content_tag ct on t.tag_id = ct.tag_id
     where t.is_deleted = 'N'
       and t.company_id = #{comId}
    <if test="tagName != null and tagName != ''">
       and t.tag_name like concat('%', #{tagName}, '%')
    </if>
     group by t.tag_id, t.tag_name
     order by t.created_at desc
  </select>

  <select id="findAllTagsByContentId"
    resultType="org.hit.hradar.domain.competencyReport.query.dto.TagDTO">
    select ctt.tag_id
         , tg.tag_name
      from content_tag ctt
      join tag tg using(tag_id)
     where tg.is_deleted = 'N'
       and tg.company_id = #{comId}
       and ctt.content_id = #{contentId}
  </select>

  <select id="findTagsByTagName"
    resultType="org.hit.hradar.domain.competencyReport.query.dto.TagDTO">
    select t.tag_id
         , t.tag_name
      from tag t
     where t.is_deleted = 'N'
       and t.company_id = #{comId}
       and t.tag_name like concat('%', #{tagName}, '%')
  </select>
</mapper>
