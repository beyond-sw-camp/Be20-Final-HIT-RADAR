<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.hit.hradar.domain.goal.query.mapper.GoalMapper">
    <select id="selectGoals"
            parameterType="long"
            resultType="org.hit.hradar.domain.goal.query.dto.response.GoalNodeResponseDto">

        SELECT
            g.goal_id             AS goalId,
            g.parent_goal_id      AS parentGoalId,
            g.goal_depth          AS depth,
            g.goal_type           AS type,
            g.goal_title          AS title,
            g.goal_approve_status AS approveStatus,
            g.owner_id            AS ownerId,
            e.name                AS ownerName
        FROM goal g
                 LEFT JOIN employee e
                           ON g.owner_id = e.emp_id
                               AND e.is_deleted = 'N'
        WHERE g.goal_dept_id = #{departmentId}
          AND g.is_deleted = 'N'
        ORDER BY g.goal_depth, g.goal_id
    </select>

    <select id="selectKpisByGoalIds"
            resultType="org.hit.hradar.domain.goal.query.dto.response.KpiListResponseDto">

        SELECT
        kd.goal_id            AS goalId,
        kd.kpi_id             AS kpiId,
        kd.kpi_metric_name    AS metricName,
        kd.kpi_start_value    AS startValue,
        kd.kpi_target_value   AS targetValue,

        /* currentValue = start + SUM(log_value) */
        (
        kd.kpi_start_value + IFNULL(SUM(kpl.log_value), 0)
        ) AS currentValue,

        /* progressRate */
        CASE
        WHEN (kd.kpi_target_value - kd.kpi_start_value) = 0 THEN 0
        ELSE
        LEAST(
        100,
        GREATEST(
        0,
        (
        (
        (kd.kpi_start_value + IFNULL(SUM(kpl.log_value), 0))
        - kd.kpi_start_value
        )
        / (kd.kpi_target_value - kd.kpi_start_value)
        ) * 100
        )
        )
        END AS progressRate

        FROM kpi_detail kd
        LEFT JOIN kpi_progress_log kpl
        ON kpl.kpi_id = kd.kpi_id
        AND kpl.is_deleted = 'N'

        WHERE kd.is_deleted = 'N'
        AND kd.goal_id IN
        <foreach collection="goalIds" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>

        GROUP BY
        kd.goal_id,
        kd.kpi_id,
        kd.kpi_metric_name,
        kd.kpi_start_value,
        kd.kpi_target_value

        ORDER BY kd.kpi_id ASC
    </select>
    <select id="selectOkrsByGoalIds"
            resultType="org.hit.hradar.domain.goal.query.dto.response.OkrListResponseDto">

        SELECT
        kr.goal_id              AS goalId,
        kr.key_result_id        AS keyResultId,
        kr.key_result_content   AS content,
        kr.okr_metric_name      AS metricName,
        kr.key_target_value     AS targetValue,

        /* 최신 current_progress */
        COALESCE(latest.current_progress, 0) AS currentValue,

        /* progressRate */
        CASE
        WHEN kr.key_target_value = 0 THEN 0
        ELSE
        LEAST(
        100,
        GREATEST(
        0,
        (COALESCE(latest.current_progress, 0)
        / kr.key_target_value) * 100
        )
        )
        END AS progressRate

        FROM okr_key_result kr

        LEFT JOIN (
        SELECT
        p.key_result_id,
        p.current_progress
        FROM okr_progress_log p
        INNER JOIN (
        SELECT
        key_result_id,
        MAX(log_date) AS maxLogDate
        FROM okr_progress_log
        WHERE is_deleted = 'N'
        GROUP BY key_result_id
        ) lastLog
        ON p.key_result_id = lastLog.key_result_id
        AND p.log_date = lastLog.maxLogDate
        WHERE p.is_deleted = 'N'
        ) latest
        ON latest.key_result_id = kr.key_result_id

        WHERE kr.is_deleted = 'N'
        AND kr.goal_id IN
        <foreach collection="goalIds" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>

        ORDER BY kr.key_result_id ASC
    </select>

    <select id="selectMyGoals"
            resultType="org.hit.hradar.domain.goal.query.dto.response.GoalNodeResponseDto">

        SELECT
            g.goal_id             AS goalId,
            g.parent_goal_id      AS parentGoalId,
            g.goal_depth          AS depth,
            g.goal_type           AS type,
            g.goal_title          AS title,
            g.goal_approve_status AS approveStatus,
            g.owner_id            AS ownerId
        FROM goal g
        WHERE g.owner_id = #{ownerId}
          AND g.is_deleted = 'N'
        ORDER BY g.goal_depth, g.goal_id
    </select>

  <select id="findAllByCyclePeriod"
    resultType="org.hit.hradar.domain.goal.query.dto.response.CyclePeriodGoalsRow">

    SELECT gl.goal_id
         , gl.goal_dept_id
         , gl.goal_depth
         , gl.goal_scope
         , gl.goal_type
         , gl.goal_title
         , gl.goal_description
         , gl.goal_start_date
         , gl.goal_end_date
         , gl.owner_id
         , emp.NAME AS employeeName
         , dep.DEPT_NAME as deptName
         , cp.NAME AS positionName
         , gl.goal_approve_status AS approveStatus
         , gl.goal_status AS progressStatus
         , kd.kpi_metric_name
         , kd.kpi_start_value
         , kd.kpi_target_value
         , okr.key_result_content
         , okr.is_achieved
         , okr.okr_metric_name
         , okr.key_target_value
      FROM goal gl
      LEFT JOIN kpi_detail kd ON gl.goal_id = kd.goal_id
       AND kd.is_deleted = 'N'
      LEFT JOIN okr_key_result okr ON gl.goal_id = okr.goal_id
       AND okr.is_deleted = 'N'
      JOIN employee emp ON gl.OWNER_ID = emp.EMP_ID
       AND emp.IS_DELETED = 'N'
       AND emp.TYPE = 'WORKING'
      JOIN department dep ON emp.DEPT_ID = dep.DEPT_ID
       AND dep.IS_DELETED = 'N'
      JOIN company_position cp ON emp.POSITION_ID = cp.POSITION_ID
       AND cp.IS_DELETED = 'N'
     WHERE gl.is_deleted = 'N'
       AND gl.GOAL_SCOPE = 'PERSONAL'
       AND gl.goal_approve_status = 'APPROVED'
       AND gl.goal_depth IN ('LEVEL_2', 'LEVEL_3')
       AND gl.goal_start_date &gt;= #{startDate}
       AND gl.goal_end_date   &lt;= #{endDate}
  </select>
</mapper>
