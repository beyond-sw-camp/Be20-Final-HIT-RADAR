<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.hit.hradar.domain.goal.query.mapper.KpiDetailMapper">
    <select id="findKpiSummary"
            parameterType="long"
            resultType="org.hit.hradar.domain.goal.query.dto.response.KpiDetailResponseDto">

        SELECT
            kd.kpi_id           AS kpiId,
            kd.kpi_metric_name  AS metricName,
            kd.kpi_start_value  AS startValue,
            kd.kpi_target_value AS targetValue,

            /* 누적값 = start + SUM(log_value) */
            (
                kd.kpi_start_value
                    + IFNULL(SUM(kpl.log_value), 0)
                ) AS currentValue,

            /* 진행률 계산 */
            CASE
                WHEN (kd.kpi_target_value - kd.kpi_start_value) = 0 THEN 0
                ELSE
                    LEAST(
                            100,
                            GREATEST(
                                    0,
                                    (
                                        (
                                            (kd.kpi_start_value + IFNULL(SUM(kpl.log_value), 0))
                                                - kd.kpi_start_value
                                            )
                                            / (kd.kpi_target_value - kd.kpi_start_value)
                                        ) * 100
                            )
                    )
                END AS progressRate

        FROM kpi_detail kd
                 LEFT JOIN kpi_progress_log kpl
                           ON kpl.kpi_id = kd.kpi_id
                               AND kpl.is_deleted = 'N'

        WHERE kd.kpi_id = #{kpiId}
          AND kd.is_deleted = 'N'

        GROUP BY
            kd.kpi_id,
            kd.kpi_metric_name,
            kd.kpi_start_value,
            kd.kpi_target_value


    </select>
    <select id="findKpiLogs"
            parameterType="long"
            resultType="org.hit.hradar.domain.goal.query.dto.response.KpiProgressLogResponseDto">

        SELECT
            kpl.log_date AS logDate,
            kpl.log_value AS inputValue,

            /* 날짜 순으로 누적 SUM */
            (
                kd.kpi_start_value
                    + SUM(kpl.log_value)
                          OVER (ORDER BY kpl.log_date)
                ) AS cumulativeValue,

            /* 해당 시점 진행률 */
            CASE
                WHEN (kd.kpi_target_value - kd.kpi_start_value) = 0 THEN 0
                ELSE
                    LEAST(
                            100,
                            GREATEST(
                                    0,
                                    (
                                        (
                                            (
                                                kd.kpi_start_value
                                                    + SUM(kpl.log_value)
                                                          OVER (ORDER BY kpl.log_date)
                                                )
                                                - kd.kpi_start_value
                                            )
                                            / (kd.kpi_target_value - kd.kpi_start_value)
                                        ) * 100
                            )
                    )
                END AS progressRate

        FROM kpi_progress_log kpl
                 JOIN kpi_detail kd
                      ON kd.kpi_id = kpl.kpi_id

        WHERE kpl.kpi_id = #{kpiId}
          AND kpl.is_deleted = 'N'
          AND kd.is_deleted = 'N'

        ORDER BY kpl.log_date ASC

    </select>
</mapper>