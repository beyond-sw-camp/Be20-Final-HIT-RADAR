<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.hit.hradar.domain.goal.query.mapper.OkrListMapper">

    <select id="findOkrsByGoalId"
            parameterType="long"
            resultType="org.hit.hradar.domain.goal.query.dto.response.OkrListResponseDto">

        SELECT
        kr.goal_id            AS goalId,
        kr.key_result_id      AS keyResultId,
        kr.key_result_content AS content,
        kr.okr_metric_name    AS metricName,
        kr.key_target_value   AS targetValue,

        COALESCE(latest.current_progress, 0) AS currentValue,

        CASE
        WHEN kr.key_target_value = 0 THEN 0
        ELSE
        LEAST(
        100,
        GREATEST(
        0,
        (COALESCE(latest.current_progress, 0)
        / kr.key_target_value) * 100
        )
        )
        END AS progressRate

        FROM okr_key_result kr
        LEFT JOIN (
        SELECT
        p.key_result_id,
        p.current_progress
        FROM okr_progress_log p
        INNER JOIN (
        SELECT
        key_result_id,
        MAX(log_date) AS maxLogDate
        FROM okr_progress_log
        WHERE is_deleted = 'N'
        GROUP BY key_result_id
        ) lastLog
        ON p.key_result_id = lastLog.key_result_id
        AND p.log_date = lastLog.maxLogDate
        WHERE p.is_deleted = 'N'
        ) latest
        ON latest.key_result_id = kr.key_result_id

        WHERE kr.goal_id = #{goalId}
        AND kr.is_deleted = 'N'

        ORDER BY kr.key_result_id ASC
    </select>

</mapper>
