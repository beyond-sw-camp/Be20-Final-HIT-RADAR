<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.hit.hradar.domain.goal.query.mapper.KpiListMapper">

    <select id="findKpisByGoalId"
            parameterType="long"
            resultType="org.hit.hradar.domain.goal.query.dto.response.KpiListResponseDto">

        SELECT
        kd.goal_id            AS goalId,
        kd.kpi_id             AS kpiId,
        kd.kpi_metric_name    AS metricName,
        kd.kpi_start_value    AS startValue,
        kd.kpi_target_value   AS targetValue,

        (
        kd.kpi_start_value + IFNULL(SUM(kpl.log_value), 0)
        ) AS currentValue,

        CASE
        WHEN (kd.kpi_target_value - kd.kpi_start_value) = 0 THEN 0
        ELSE
        LEAST(
        100,
        GREATEST(
        0,
        (
        (
        (kd.kpi_start_value + IFNULL(SUM(kpl.log_value), 0))
        - kd.kpi_start_value
        )
        / (kd.kpi_target_value - kd.kpi_start_value)
        ) * 100
        )
        )
        END AS progressRate

        FROM kpi_detail kd
        LEFT JOIN kpi_progress_log kpl
        ON kpl.kpi_id = kd.kpi_id
        AND kpl.is_deleted = 'N'

        WHERE kd.goal_id = #{goalId}
        AND kd.is_deleted = 'N'

        GROUP BY
        kd.goal_id,
        kd.kpi_id,
        kd.kpi_metric_name,
        kd.kpi_start_value,
        kd.kpi_target_value

        ORDER BY kd.kpi_id ASC
    </select>

</mapper>
