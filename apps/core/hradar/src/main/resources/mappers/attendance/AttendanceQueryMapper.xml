<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.hit.hradar.domain.attendance.query.mapper.AttendanceQueryMapper">

  <!-- 근태 목록 조회 (기간) -->
  <select id="findAttendanceList"
    parameterType="org.hit.hradar.domain.attendance.query.dto.request.AttendanceListQueryRequest"
    resultType="org.hit.hradar.domain.attendance.query.dto.response.AttendanceListResponseDto">

    SELECT
    a.work_date AS workDate,
    a.emp_id AS empId,
    e.name AS empName,
    d.dept_name AS departmentName,
    a.work_type AS workType,
    a.status AS status,
    MIN(w.start_at) AS checkInTime,
    MAX(w.end_at) AS checkOutTime,
    COALESCE(
    SUM(TIMESTAMPDIFF(MINUTE, w.start_at, w.end_at)), 0
    ) AS totalWorkMinutes
    FROM attendance a
    JOIN employee e ON a.emp_id = e.emp_id
    LEFT JOIN department d ON e.dept_id = d.dept_id
    LEFT JOIN attendance_work_log w
    ON w.attendance_id = a.attendance_id
    AND w.is_deleted = 'N'
    WHERE a.emp_id = #{targetEmpId}
    AND a.work_date BETWEEN #{fromDate} AND #{toDate}
    GROUP BY
    a.work_date,
    a.emp_id,
    e.name,
    d.dept_name,
    a.work_type,
    a.status
    ORDER BY a.work_date ASC
  </select>

  <!-- WorkLog 타임라인 resultMap -->
  <resultMap id="WorkLogTimelineResultMap"
    type="org.hit.hradar.domain.attendance.query.dto.response.WorkLogTimelineItemDto">
    <result property="workLogType" column="work_log_type"/>
    <result property="startAt" column="start_at"/>
    <result property="location" column="location"/>
  </resultMap>

  <!-- 근태 상세 resultMap -->
  <resultMap id="AttendanceDetailResultMap"
    type="org.hit.hradar.domain.attendance.query.dto.response.AttendanceDetailResponseDto">

    <id property="attendanceId" column="attendance_id"/>
    <result property="empId" column="emp_id"/>
    <result property="empName" column="emp_name"/>
    <result property="deptId" column="dept_id"/>
    <result property="workDate" column="work_date"/>
    <result property="status" column="status"/>
    <result property="workType" column="work_type"/>
    <result property="workPlace" column="work_place"/>
    <result property="checkInTime" column="check_in_time"/>
    <result property="checkOutTime" column="check_out_time"/>
    <result property="totalWorkMinutes" column="total_work_minutes"/>
    <result property="overtimeMinutes" column="overtime_minutes"/>
    <result property="overtimeStatus" column="overtime_status"/>

    <collection property="timeline"
      resultMap="WorkLogTimelineResultMap"/>
  </resultMap>


  <!-- 근태 상세 조회 (하루) -->
  <select id="findAttendanceDetail"
    parameterType="org.hit.hradar.domain.attendance.query.dto.request.AttendanceDetailQueryRequest"
    resultMap="AttendanceDetailResultMap">

    SELECT
    a.attendance_id
    , a.emp_id
    , e.name AS emp_name
    , a.work_date
    , a.status
    , e.dept_id
    , a.work_type
    , (SELECT location FROM attendance_work_log
       WHERE attendance_id = a.attendance_id AND is_deleted = 'N'
       ORDER BY start_at DESC LIMIT 1) AS work_place
    , w.work_log_type
    , w.start_at
    , w.location
    , MIN(w.start_at) OVER () AS check_in_time
    , CASE
        WHEN SUM(CASE WHEN w.end_at IS NULL THEN 1 ELSE 0 END) OVER () > 0 THEN NULL
        ELSE MAX(w.end_at) OVER ()
      END AS check_out_time
    , COALESCE(
    SUM(TIMESTAMPDIFF(MINUTE, w.start_at, w.end_at)) OVER (), 0
    ) AS total_work_minutes
    , (SELECT SUM(overtime_minutes) FROM attendance_overtime 
        WHERE emp_id = a.emp_id AND overtime_date = a.work_date AND is_deleted = 'N' AND status = 'APPROVED') AS overtime_minutes
    , CASE WHEN (SELECT COUNT(*) FROM attendance_overtime 
        WHERE emp_id = a.emp_id AND overtime_date = a.work_date AND is_deleted = 'N' AND status = 'APPROVED') > 0 THEN '발생' ELSE '미발생' END AS overtime_status
    FROM attendance a
    JOIN employee e ON a.emp_id = e.emp_id
    LEFT JOIN attendance_work_log w
    ON w.attendance_id = a.attendance_id
    AND w.is_deleted = 'N'
    /* wp 조인은 work_plan 조회용 (overtime_minutes 조회용이 아님) */
    LEFT JOIN attendance_work_plan wp
    ON wp.emp_id = a.emp_id 
    AND wp.status = 'APPROVED'
    AND a.work_date BETWEEN DATE(wp.start_at) AND DATE(wp.end_at)
    AND wp.work_type != 'WORK' /* OVERTIME은 제외 */
    WHERE a.emp_id = #{targetEmpId}
    AND a.work_date = #{workDate}
    ORDER BY w.start_at ASC

  </select>

  <select id="findAttendanceCalendar"
    parameterType="org.hit.hradar.domain.attendance.query.dto.request.AttendanceListQueryRequest"
    resultType="org.hit.hradar.domain.attendance.query.dto.response.AttendanceCalendarItemDto">

    SELECT
      a.attendance_id AS attendanceId,
      a.emp_id        AS empId,
      e.name          AS empName,
      a.work_date     AS workDate,
      a.work_type     AS workType,
      CASE
        WHEN a.status = 'LEAVE' THEN a.work_type
        /* 출근 중인지 확인 (퇴근 기록이 없는 로그가 존재하면 출근 중) */
        WHEN (SELECT COUNT(*) FROM attendance_work_log wl 
              WHERE wl.attendance_id = a.attendance_id AND wl.end_at IS NULL AND wl.is_deleted = 'N') > 0 THEN
          CASE
            WHEN a.work_type = 'REMOTE' THEN '재택'
            WHEN a.work_type = 'OUTSIDE' THEN '외근'
            ELSE '출근'
          END
        /* 퇴근했는지 확인 (로그는 있는데 모두 닫혀있으면 퇴근) */
        WHEN (SELECT COUNT(*) FROM attendance_work_log wl 
              WHERE wl.attendance_id = a.attendance_id AND wl.is_deleted = 'N') > 0 THEN '퇴근'
        ELSE '미출근'
      END AS status,
      d.dept_name     AS departmentName,
      p.name          AS jobTitle,
      (SELECT COALESCE(SUM(TIMESTAMPDIFF(MINUTE, wl.start_at, IFNULL(wl.end_at, NOW()))), 0)
       FROM attendance_work_log wl
       WHERE wl.attendance_id = a.attendance_id AND wl.is_deleted = 'N') AS totalWorkMinutes,
      /* 초과근무 시간 */
      (SELECT COALESCE(SUM(overtime_minutes), 0)
       FROM attendance_overtime
       WHERE emp_id = a.emp_id 
         AND status = 'APPROVED'
         AND overtime_date = a.work_date
         AND is_deleted = 'N') AS overtimeMinutes,
      /* 최신 근무 위치 */
      (SELECT wl.location FROM attendance_work_log wl
       WHERE wl.attendance_id = a.attendance_id AND wl.is_deleted = 'N'
       ORDER BY wl.start_at DESC LIMIT 1) AS location,
      /* 출근 시간 */
      (SELECT MIN(wl.start_at) FROM attendance_work_log wl 
       WHERE wl.attendance_id = a.attendance_id AND wl.is_deleted = 'N') AS checkInTime,
      /* 퇴근 시간 */
      (SELECT CASE WHEN COUNT(CASE WHEN wl.end_at IS NULL THEN 1 END) = 0 THEN MAX(wl.end_at) ELSE NULL END 
       FROM attendance_work_log wl 
       WHERE wl.attendance_id = a.attendance_id AND wl.is_deleted = 'N') AS checkOutTime
    FROM attendance a
    JOIN employee e ON a.emp_id = e.emp_id
    LEFT JOIN department d ON e.dept_id = d.dept_id
    LEFT JOIN company_position p ON e.position_id = p.position_id
   WHERE a.is_deleted = 'N'
   <if test="targetEmpId != null">
     AND a.emp_id = #{targetEmpId}
   </if>
   <if test="targetDeptId != null">
     AND e.dept_id = #{targetDeptId}
   </if>
    AND a.work_date BETWEEN #{fromDate} AND #{toDate}
   ORDER By a.work_date ASC, e.name ASC

  </select>

</mapper>
