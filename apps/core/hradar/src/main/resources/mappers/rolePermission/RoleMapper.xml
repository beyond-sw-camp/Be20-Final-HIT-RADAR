<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.hit.hradar.domain.rolePermission.query.mapper.RoleMapper">

  <resultMap id="RoleResponseMap" type="org.hit.hradar.domain.rolePermission.query.dto.RoleResponse">
    <id property="roleId" column="role_id"/>
    <result property="name" column="name"/>
    <result property="isSystem" column="is_system"/>
    <result property="roleKey" column="role_key"/>
  </resultMap>

  <select id="selectRoles" resultMap="RoleResponseMap">
    SELECT
      role_id,
      name,
      is_system,
      role_key
    FROM role
    WHERE com_id = #{comId}
      AND is_deleted = 'N'
    <if test="req.keyword != null and req.keyword != ''">
      AND name LIKE CONCAT('%', #{req.keyword}, '%')
    </if>
    ORDER BY is_system DESC, name ASC
  </select>

  <select id="selectRole" resultMap="RoleResponseMap">
    SELECT
      role_id,
      name,
      is_system,
      role_key
    FROM role
    WHERE com_id = #{comId}
      AND role_id = #{roleId}
      AND is_deleted = 'N'
  </select>

  <select id="selectRolePermissions" resultType="org.hit.hradar.domain.rolePermission.query.dto.PermissionResponse">
    SELECT
      p.perm_id AS permId,
      p.perm_key AS permKey,
      p.name AS name,
      p.route_path AS routePath,
      p.description AS description
    FROM role_permission rp
    JOIN permission p ON rp.perm_id = p.perm_id
    WHERE rp.role_id = #{roleId}
  </select>

  <select id="selectAllPermissions" resultType="org.hit.hradar.domain.rolePermission.query.dto.PermissionResponse">
    SELECT
      perm_id AS permId,
      perm_key AS permKey,
      name AS name,
      route_path AS routePath,
      description AS description
    FROM permission
    WHERE is_deleted = 'N'
    ORDER BY perm_id ASC
  </select>

  <select id="selectAssignedMembers" resultType="org.hit.hradar.domain.rolePermission.query.dto.RoleAssignedMember">
    SELECT
      e.emp_id AS empId,
      e.name AS name,
      d.dept_name AS departmentName,
      cp.name AS positionName,
      e.image AS image
    FROM role_employee re
    JOIN employee e ON re.emp_id = e.emp_id
    LEFT JOIN department d ON e.dept_id = d.dept_id
    LEFT JOIN company_position cp ON e.position_id = cp.position_id
    WHERE re.role_id = #{roleId}
      AND e.is_deleted = 'N'
    ORDER BY e.name ASC
  </select>

  <select id="selectPermissionKeysByEmpId" resultType="string">
    SELECT DISTINCT p.perm_key
    FROM role_employee re
    JOIN role r ON re.role_id = r.role_id
    JOIN role_permission rp ON r.role_id = rp.role_id
    JOIN permission p ON rp.perm_id = p.perm_id
    WHERE re.emp_id = #{empId}
      AND r.is_deleted = 'N'
      AND p.is_deleted = 'N'
  </select>

</mapper>
